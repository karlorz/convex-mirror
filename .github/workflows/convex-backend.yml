name: Mirror Convex Backend

on:
  # Run on manual trigger
  workflow_dispatch:
    inputs:
      dockerhub_repo:
        description: 'Docker Hub repository (e.g., username/convex-backend)'
        required: true
        default: 'karl8080/convex-backend'
      mirror_sha_tag:
        description: 'Also mirror SHA tag (6efab6f2b6c182b90255774d747328cfc7b80dd9)?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

env:
  GHCR_SOURCE: ghcr.io/get-convex/convex-backend
  SHA_TAG: 6efab6f2b6c182b90255774d747328cfc7b80dd9
  DOCKERHUB_REPO: karl8080/convex-backend

jobs:
  mirror-latest:
    runs-on: ubuntu-latest

    steps:
      - name: Install regctl
        run: |
          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 -o regctl
          chmod +x regctl
          sudo mv regctl /usr/local/bin/

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Mirror multi-platform image to Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:latest"
          echo "Mirroring: ${{ env.GHCR_SOURCE }}:latest → $TARGET"
          regctl image copy ${{ env.GHCR_SOURCE }}:latest $TARGET

      - name: Verify push
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:latest"
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:latest → $TARGET"
          regctl manifest get $TARGET --format raw-body --require-list | jq -r '.manifests[].platform | "\(.os)/\(.architecture)"'

  mirror-sha:
    runs-on: ubuntu-latest
    if: github.event.inputs.mirror_sha_tag != 'false' || github.event_name == 'schedule'

    steps:
      - name: Install regctl
        run: |
          curl -L https://github.com/regclient/regclient/releases/latest/download/regctl-linux-amd64 -o regctl
          chmod +x regctl
          sudo mv regctl /usr/local/bin/

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Mirror multi-platform image to Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:${{ env.SHA_TAG }}"
          echo "Mirroring: ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} → $TARGET"
          regctl image copy ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} $TARGET

      - name: Verify push
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:${{ env.SHA_TAG }}"
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} → $TARGET"
          regctl manifest get $TARGET --format raw-body --require-list | jq -r '.manifests[].platform | "\(.os)/\(.architecture)"'
