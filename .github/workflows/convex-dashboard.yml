name: Mirror Convex Dashboard

on:
  # Run on manual trigger
  workflow_dispatch:
    inputs:
      dockerhub_repo:
        description: 'Docker Hub repository (e.g., username/convex-dashboard)'
        required: true
        default: 'karl8080/convex-dashboard'
      mirror_sha_tag:
        description: 'Also mirror SHA tag (6efab6f2b6c182b90255774d747328cfc7b80dd9)?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

env:
  GHCR_SOURCE: ghcr.io/get-convex/convex-dashboard
  SHA_TAG: 6efab6f2b6c182b90255774d747328cfc7b80dd9
  DOCKERHUB_REPO: karl8080/convex-dashboard

jobs:
  mirror-latest:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Mirror multi-platform image to Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:latest"
          echo "Mirroring: ${{ env.GHCR_SOURCE }}:latest → $TARGET"
          docker buildx imagetools create --tag $TARGET ${{ env.GHCR_SOURCE }}:latest

      - name: Verify push
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:latest"
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:latest → $TARGET"
          docker buildx imagetools inspect $TARGET

  mirror-sha:
    runs-on: ubuntu-latest
    if: github.event.inputs.mirror_sha_tag != 'false' || github.event_name == 'schedule'

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Mirror multi-platform image to Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:${{ env.SHA_TAG }}"
          echo "Mirroring: ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} → $TARGET"
          docker buildx imagetools create --tag $TARGET ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }}

      - name: Verify push
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:${{ env.SHA_TAG }}"
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} → $TARGET"
          docker buildx imagetools inspect $TARGET
