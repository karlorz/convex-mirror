name: Mirror Convex Backend

on:
  # Run on manual trigger
  workflow_dispatch:
    inputs:
      dockerhub_repo:
        description: 'Docker Hub repository (e.g., username/convex-backend)'
        required: true
        default: 'karlorz/convex-mirror'
      mirror_sha_tag:
        description: 'Also mirror SHA tag (6efab6f2b6c182b90255774d747328cfc7b80dd9)?'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

  # Run weekly on Sundays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

env:
  GHCR_SOURCE: ghcr.io/get-convex/convex-backend
  SHA_TAG: 6efab6f2b6c182b90255774d747328cfc7b80dd9
  DOCKERHUB_REPO: karlorz/convex-mirror

jobs:
  mirror-latest:
    runs-on: ubuntu-latest

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull latest from GHCR
        run: |
          echo "Pulling: ${{ env.GHCR_SOURCE }}:latest"
          docker pull ${{ env.GHCR_SOURCE }}:latest

      - name: Tag for Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:latest"
          echo "Tagging as: $TARGET"
          docker tag ${{ env.GHCR_SOURCE }}:latest $TARGET
          echo "target=$TARGET" >> $GITHUB_ENV

      - name: Push to Docker Hub
        run: |
          echo "Pushing: ${{ env.target }}"
          docker push ${{ env.target }}

      - name: Verify push
        run: |
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:latest → ${{ env.target }}"

  mirror-sha:
    runs-on: ubuntu-latest
    if: github.event.inputs.mirror_sha_tag != 'false' || github.event_name == 'schedule'

    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull SHA tag from GHCR
        run: |
          echo "Pulling: ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }}"
          docker pull ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }}

      - name: Tag for Docker Hub
        run: |
          TARGET="${{ github.event.inputs.dockerhub_repo || env.DOCKERHUB_REPO }}:${{ env.SHA_TAG }}"
          echo "Tagging as: $TARGET"
          docker tag ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} $TARGET
          echo "target=$TARGET" >> $GITHUB_ENV

      - name: Push to Docker Hub
        run: |
          echo "Pushing: ${{ env.target }}"
          docker push ${{ env.target }}

      - name: Verify push
        run: |
          echo "✓ Successfully mirrored ${{ env.GHCR_SOURCE }}:${{ env.SHA_TAG }} → ${{ env.target }}"
